using System.Configuration;
using System.Data;
using System.Windows;

namespace CheckListCreator
{
    /// <summary>
    /// Interaction logic for App.xaml
    /// </summary>
    public partial class App : Application
    {
    }

}
using System.Windows;

[assembly: ThemeInfo(
    ResourceDictionaryLocation.None,            //where theme specific resource dictionaries are located
                                                //(used if a resource is not found in the page,
                                                // or application resource dictionaries)
    ResourceDictionaryLocation.SourceAssembly   //where the generic resource dictionary is located
                                                //(used if a resource is not found in the page,
                                                // app, or any theme specific resource dictionaries)
)]
﻿using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Linq;
using System.Runtime.CompilerServices;

namespace CheckListCreator
{
    public class Checklist : INotifyPropertyChanged
    {
        private string _name;
        private string _description;
        private int _completness;
        private List<Task> _tasks;
        private bool _isUpdating;

        public string Name
        {
            get => _name;
            set
            {
                _name = value;
                OnPropertyChanged();
            }
        }

        public List<Task> Tasks
        {
            get => _tasks;
            set
            {
                _tasks = value;
                OnPropertyChanged();
            }
        }

        public int Completness
        {
            get => _completness;
            private set
            {
                if (_completness != value)
                {
                    _completness = value;
                    OnPropertyChanged();
                }
            }
        }

        public bool CompleteFlag => Completness == 100;

        public string Description
        {
            get => _description;
            set
            {
                _description = value;
                OnPropertyChanged();
            }
        }

        public Guid Id { get; private set; }

        public Checklist(string name, List<Task> tasks, string description = "")
        {
            Id = Guid.NewGuid();
            Name = name;
            Tasks = tasks ?? new List<Task>();
            Description = description;
            _isUpdating = false;
            UpdateProgress();
        }

        public void AddTask(Task task)
        {
            Tasks.Add(task);
            UpdateProgress();
        }

        public void RemoveTask(Task task)
        {
            Tasks.Remove(task);
            UpdateProgress();
        }

        public void UpdateProgress()
        {
            if (_isUpdating) return;
            _isUpdating = true;

            try
            {
                if (Tasks == null || Tasks.Count == 0)
                {
                    Completness = 0;
                    return;
                }

                // Считаем средний прогресс по всем основным задачам
                int totalProgress = 0;
                int taskCount = Tasks.Count;

                foreach (var task in Tasks)
                {
                    totalProgress += GetTaskProgress(task);
                }

                Completness = taskCount > 0 ? totalProgress / taskCount : 0;
            }
            finally
            {
                _isUpdating = false;
            }
        }

        private int GetTaskProgress(Task task)
        {
            // Всегда используем текущий прогресс задачи
            // Для задач с подзадачами прогресс будет обновляться автоматически
            return task.Completness;
        }

        // Метод для подсчета количества выполненных задач (для отображения)
        public int GetCompletedTasksCount()
        {
            return Tasks.Count(task => task.CompleteFlag);
        }

        public override string ToString()
        {
            string tasks = Tasks?.Count > 0 ? $" [Задачи: {Tasks.Count}]" : "";
            string completed = Completness == 100 ? "✅" : Completness == 0 ? "❎" : $"{Completness}%";

            return $"{Name} ({completed}) - {Description}{tasks}";
        }

        public event PropertyChangedEventHandler PropertyChanged;

        protected virtual void OnPropertyChanged([CallerMemberName] string propertyName = null)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }
    }
}﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Windows;
using System.Windows.Controls;

namespace CheckListCreator
{
    public partial class ChecklistEditor : Page
    {
        private Checklist _checklist;
        private List<Checklist> _allChecklists;
        private DataService _dataService;

        public ChecklistEditor(Checklist checklist, List<Checklist> allChecklists)
        {
            InitializeComponent();
            _checklist = checklist;
            _allChecklists = allChecklists;
            _dataService = new DataService();
            LoadChecklistData();
        }

        private void LoadChecklistData()
        {
            ChecklistName.Text = _checklist.Name;
            ChecklistDescription.Text = _checklist.Description;
            RefreshTasksList();
            UpdateProgress();
        }

        private void RefreshTasksList()
        {
            TasksList.ItemsSource = null;
            TasksList.ItemsSource = _checklist.Tasks;
        }

        private void UpdateProgress()
        {
            _checklist.UpdateProgress();

            // Считаем статистику для отображения
            var totalMainTasks = _checklist.Tasks.Count;
            var completedMainTasks = _checklist.GetCompletedTasksCount();
            var averageProgress = _checklist.Completness;

            ProgressText.Text = $"Прогресс: {averageProgress}% ({completedMainTasks}/{totalMainTasks} задач завершено)";

            // Сохраняем изменения при каждом обновлении прогресса
            _dataService.SaveChecklists(_allChecklists);
        }

        private void BackButton_Click(object sender, RoutedEventArgs e)
        {
            var mainWindow = Application.Current.MainWindow as MainWindow;
            mainWindow?.MainFrame.Navigate(new ChecklistsList());
        }

        private void ChecklistName_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (!string.IsNullOrWhiteSpace(ChecklistName.Text))
            {
                _checklist.Name = ChecklistName.Text.Trim();
                UpdateProgress();
            }
        }

        private void ChecklistDescription_TextChanged(object sender, TextChangedEventArgs e)
        {
            _checklist.Description = ChecklistDescription.Text.Trim();
            UpdateProgress();
        }

        private void TaskCheckBox_Changed(object sender, RoutedEventArgs e)
        {
            if (sender is CheckBox checkBox && checkBox.DataContext is Task task)
            {
                try
                {
                    // Инвертируем значение галочки
                    // Вся логика синхронизации с подзадачами и прогрессом теперь в свойстве CompleteFlag
                    task.CompleteFlag = !task.CompleteFlag;

                    // Обновляем прогресс чек-листа
                    _checklist.UpdateProgress();
                    UpdateProgress();

                    // Обновляем отображение списка
                    RefreshTasksList();
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Ошибка при изменении задачи: {ex.Message}", "Ошибка",
                        MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        private void SubTaskCheckBox_Changed(object sender, RoutedEventArgs e)
        {
            if (sender is CheckBox checkBox && checkBox.DataContext is Task subTask)
            {
                try
                {
                    // Инвертируем значение подзадачи
                    subTask.CompleteFlag = !subTask.CompleteFlag;

                    // Находим родительскую задачу и обновляем её прогресс на основе подзадач
                    var parentTask = FindParentTask(subTask);
                    if (parentTask != null)
                    {
                        parentTask.UpdateProgressFromSubTasks();
                    }

                    // Обновляем прогресс чек-листа
                    _checklist.UpdateProgress();
                    UpdateProgress();

                    // Обновляем отображение списка
                    RefreshTasksList();
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Ошибка при изменении подзадачи: {ex.Message}", "Ошибка",
                        MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        private Task FindParentTask(Task subTask)
        {
            foreach (var task in _checklist.Tasks)
            {
                if (task.SubTasks.Contains(subTask))
                {
                    return task;
                }

                // Рекурсивно ищем в подзадачах
                var parent = FindParentTaskInSubTasks(task, subTask);
                if (parent != null)
                {
                    return parent;
                }
            }
            return null;
        }

        private Task FindParentTaskInSubTasks(Task parent, Task subTask)
        {
            foreach (var child in parent.SubTasks)
            {
                if (child.SubTasks.Contains(subTask))
                {
                    return child;
                }

                var result = FindParentTaskInSubTasks(child, subTask);
                if (result != null)
                {
                    return result;
                }
            }
            return null;
        }

        private void AddTaskButton_Click(object sender, RoutedEventArgs e)
        {
            if (string.IsNullOrWhiteSpace(NewTaskName.Text))
            {
                MessageBox.Show("Введите название задачи", "Внимание",
                    MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            var newTask = new Task(NewTaskName.Text.Trim(), NewTaskDescription.Text.Trim());
            _checklist.AddTask(newTask);
            RefreshTasksList();
            UpdateProgress();

            NewTaskName.Text = "Новая задача";
            NewTaskDescription.Text = "Описание задачи";
        }

        private void DeleteTask_Click(object sender, RoutedEventArgs e)
        {
            if (((Button)sender).Tag is Task task)
            {
                var result = MessageBox.Show($"Удалить задачу '{task.Name}' и все её подзадачи?",
                    "Подтверждение удаления", MessageBoxButton.YesNo, MessageBoxImage.Question);

                if (result == MessageBoxResult.Yes)
                {
                    _checklist.RemoveTask(task);
                    RefreshTasksList();
                    UpdateProgress();
                }
            }
        }

        private void AddSubTask_Click(object sender, RoutedEventArgs e)
        {
            if (((Button)sender).Tag is Task parentTask)
            {
                // Создаем новую подзадачу
                var newSubTask = new Task("Новая подзадача", "Описание подзадачи");

                // Если родительская задача уже выполнена, новая подзадача тоже должна быть выполнена
                if (parentTask.CompleteFlag)
                {
                    newSubTask.CompleteFlag = true;
                }

                parentTask.AddSubTask(newSubTask);
                RefreshTasksList();
                UpdateProgress();
            }
        }

        private void AddSubTaskConfirm_Click(object sender, RoutedEventArgs e)
        {
            if (((Button)sender).Tag is Task parentTask)
            {
                // Находим TextBox'ы для ввода подзадачи
                var stackPanel = ((Button)sender).Parent as StackPanel;
                if (stackPanel != null)
                {
                    var nameTextBox = stackPanel.Children.OfType<TextBox>()
                        .FirstOrDefault(tb => tb.Name == "NewSubTaskName");
                    var descTextBox = stackPanel.Children.OfType<TextBox>()
                        .FirstOrDefault(tb => tb.Name == "NewSubTaskDescription");

                    if (nameTextBox != null && !string.IsNullOrWhiteSpace(nameTextBox.Text))
                    {
                        var newSubTask = new Task(nameTextBox.Text.Trim(),
                            descTextBox?.Text?.Trim() ?? "");

                        // Если родительская задача уже выполнена, новая подзадача тоже должна быть выполнена
                        if (parentTask.CompleteFlag)
                        {
                            newSubTask.CompleteFlag = true;
                        }

                        parentTask.AddSubTask(newSubTask);
                        RefreshTasksList();
                        UpdateProgress();

                        // Очищаем поля
                        if (nameTextBox != null) nameTextBox.Text = "Новая подзадача";
                        if (descTextBox != null) descTextBox.Text = "Описание";
                    }
                }
            }
        }

        private void DeleteSubTask_Click(object sender, RoutedEventArgs e)
        {
            if (((Button)sender).Tag is Task subTask)
            {
                var result = MessageBox.Show($"Удалить подзадачу '{subTask.Name}'?",
                    "Подтверждение удаления", MessageBoxButton.YesNo, MessageBoxImage.Question);

                if (result == MessageBoxResult.Yes)
                {
                    // Находим родительскую задачу
                    var parentTask = FindParentTask(subTask);
                    if (parentTask != null)
                    {
                        parentTask.RemoveSubTask(subTask);
                        RefreshTasksList();
                        UpdateProgress();
                    }
                }
            }
        }

        private void SaveButton_Click(object sender, RoutedEventArgs e)
        {
            _dataService.SaveChecklists(_allChecklists);
            MessageBox.Show("Изменения сохранены", "Успех",
                MessageBoxButton.OK, MessageBoxImage.Information);
        }

        private void DeleteChecklist_Click(object sender, RoutedEventArgs e)
        {
            var result = MessageBox.Show($"Удалить чек-лист '{_checklist.Name}'?",
                "Подтверждение удаления", MessageBoxButton.YesNo, MessageBoxImage.Question);

            if (result == MessageBoxResult.Yes)
            {
                _allChecklists.Remove(_checklist);
                _dataService.SaveChecklists(_allChecklists);

                var mainWindow = Application.Current.MainWindow as MainWindow;
                mainWindow?.MainFrame.Navigate(new ChecklistsList());
            }
        }
    }
}﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Windows;
using System.Windows.Controls;

namespace CheckListCreator
{
    public partial class ChecklistsList : Page
    {
        private List<Checklist> _checklists;
        private DataService _dataService;

        public ChecklistsList()
        {
            InitializeComponent();
            _dataService = new DataService();
            LoadChecklists();
        }

        private void LoadChecklists()
        {
            _checklists = _dataService.LoadChecklists();
            RefreshList();
        }

        private void SaveChecklists()
        {
            _dataService.SaveChecklists(_checklists);
        }

        private void Add_checklist_Click(object sender, RoutedEventArgs e)
        {
            if (string.IsNullOrWhiteSpace(NewName.Text))
            {
                MessageBox.Show("Введите название чек-листа", "Внимание",
                    MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            var newChecklist = new Checklist(NewName.Text.Trim(), null, NewDescription.Text.Trim());
            _checklists.Add(newChecklist);
            SaveChecklists();
            RefreshList();

            // Очистка полей
            NewName.Text = "Новый чек-лист";
            NewDescription.Text = "Описание";
        }

        private void DeleteChecklist_Click(object sender, RoutedEventArgs e)
        {
            if (Checklists.SelectedItem is Checklist selectedChecklist)
            {
                var result = MessageBox.Show($"Удалить чек-лист '{selectedChecklist.Name}'?",
                    "Подтверждение удаления", MessageBoxButton.YesNo, MessageBoxImage.Question);

                if (result == MessageBoxResult.Yes)
                {
                    _checklists.Remove(selectedChecklist);
                    SaveChecklists();
                    RefreshList();
                }
            }
            else
            {
                MessageBox.Show("Выберите чек-лист для удаления", "Внимание",
                    MessageBoxButton.OK, MessageBoxImage.Warning);
            }
        }

        private void Checklists_MouseDoubleClick(object sender, System.Windows.Input.MouseButtonEventArgs e)
        {
            if (Checklists.SelectedItem is Checklist selectedChecklist)
            {
                var mainWindow = Application.Current.MainWindow as MainWindow;
                mainWindow?.MainFrame.Navigate(new ChecklistEditor(selectedChecklist, _checklists));
            }
        }

        private void RefreshList()
        {
            Checklists.ItemsSource = null;
            Checklists.ItemsSource = _checklists;
        }
    }
}﻿using System;
using System.Globalization;
using System.Windows.Data;
using System.Windows.Media;

namespace CheckListCreator
{
    // Конвертер цвета прогресса
    public class ProgressColorConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is int progress)
            {
                return progress switch
                {
                    100 => new SolidColorBrush(Colors.Green),
                    >= 75 => new SolidColorBrush(Colors.DarkGreen),
                    >= 50 => new SolidColorBrush(Colors.Orange),
                    >= 25 => new SolidColorBrush(Colors.OrangeRed),
                    _ => new SolidColorBrush(Colors.Red)
                };
            }
            return new SolidColorBrush(Colors.Gray);
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }

    // Конвертер иконки статуса
    public class StatusIconConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is int progress)
            {
                return progress switch
                {
                    100 => "✅",
                    0 => "❎",
                    _ => "⏳"
                };
            }
            return "❓";
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }

    // Конвертер статистики задач
    public class TaskStatsConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is Checklist checklist && parameter is string type)
            {
                var completedTasks = checklist.Tasks.Count(t => t.CompleteFlag);
                return type == "completed" ? completedTasks : checklist.Tasks.Count;
            }
            return "0";
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
}﻿using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text.Json;
using System.Windows;

namespace CheckListCreator
{
    public class DataService
    {
        private static readonly string DataFilePath = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
            "CheckListCreator", "checklists.json");

        public List<Checklist> LoadChecklists()
        {
            try
            {
                if (!File.Exists(DataFilePath))
                    return new List<Checklist>();

                var json = File.ReadAllText(DataFilePath);
                return JsonSerializer.Deserialize<List<Checklist>>(json) ?? new List<Checklist>();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Ошибка загрузки данных: {ex.Message}", "Ошибка",
                    MessageBoxButton.OK, MessageBoxImage.Error);
                return new List<Checklist>();
            }
        }

        public void SaveChecklists(List<Checklist> checklists)
        {
            try
            {
                var directory = Path.GetDirectoryName(DataFilePath);
                if (!Directory.Exists(directory))
                    Directory.CreateDirectory(directory);

                var options = new JsonSerializerOptions { WriteIndented = true };
                var json = JsonSerializer.Serialize(checklists, options);
                File.WriteAllText(DataFilePath, json);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Ошибка сохранения данных: {ex.Message}", "Ошибка",
                    MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }
    }
}﻿using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace CheckListCreator
{
    /// <summary>
    /// Interaction logic for MainWindow.xaml
    /// </summary>
    public partial class MainWindow : Window
    {
        public MainWindow()
        {
            InitializeComponent();
            MainFrame.Content = new ChecklistsList();
        }
    }
}
﻿using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Linq;
using System.Runtime.CompilerServices;

namespace CheckListCreator
{
    public class Task : INotifyPropertyChanged
    {
        private string _name;
        private string _description;
        private int _completness;
        private bool _completeFlag;
        private List<Task> _subTasks;
        private bool _isUpdating;

        public string Name
        {
            get => _name;
            set
            {
                _name = value;
                OnPropertyChanged();
            }
        }

        public List<Task> SubTasks
        {
            get => _subTasks;
            set
            {
                _subTasks = value;
                OnPropertyChanged();
            }
        }

        public int Completness
        {
            get => _completness;
            private set
            {
                if (_completness != value)
                {
                    _completness = value;
                    OnPropertyChanged();
                }
            }
        }

        public bool CompleteFlag
        {
            get => _completeFlag;
            set
            {
                if (_completeFlag != value && !_isUpdating)
                {
                    _isUpdating = true;
                    _completeFlag = value;
                    OnPropertyChanged();

                    if (value)
                    {
                        // Если включаем галочку - включаем все подзадачи
                        SetAllSubTasksComplete(true);
                        // Для задач с подзадачами устанавливаем прогресс в 100%
                        if (HasSubTasks)
                        {
                            Completness = 100;
                        }
                    }
                    else
                    {
                        // Если выключаем галочку - выключаем все подзадачи
                        SetAllSubTasksComplete(false);
                        // Для задач с подзадачами устанавливаем прогресс в 0%
                        if (HasSubTasks)
                        {
                            Completness = 0;
                        }
                    }

                    // Для задач без подзадач обновляем прогресс
                    if (!HasSubTasks)
                    {
                        Completness = value ? 100 : 0;
                    }

                    _isUpdating = false;
                }
            }
        }

        public string Description
        {
            get => _description;
            set
            {
                _description = value;
                OnPropertyChanged();
            }
        }

        public Guid Id { get; private set; }
        public bool HasSubTasks => SubTasks?.Count > 0;

        public Task(string name, string description = "")
        {
            Id = Guid.NewGuid();
            Name = name;
            Description = description;
            SubTasks = new List<Task>();
            CompleteFlag = false;
            Completness = 0;
            _isUpdating = false;
        }

        public void AddSubTask(Task subTask)
        {
            SubTasks.Add(subTask);

            // Синхронизируем состояние, если основная задача уже выполнена
            if (CompleteFlag)
            {
                subTask.CompleteFlag = true;
            }

            UpdateProgressFromSubTasks();
        }

        public void RemoveSubTask(Task subTask)
        {
            SubTasks.Remove(subTask);
            UpdateProgressFromSubTasks();
        }

        private void SetAllSubTasksComplete(bool complete)
        {
            foreach (var subTask in SubTasks)
            {
                subTask.CompleteFlag = complete;

                // Рекурсивно применяем ко всем вложенным подзадачам
                subTask.SetAllSubTasksComplete(complete);
            }
        }

        // Обновляем прогресс на основе состояния подзадач
        public void UpdateProgressFromSubTasks()
        {
            if (_isUpdating) return;

            _isUpdating = true;

            try
            {
                if (SubTasks == null || SubTasks.Count == 0)
                {
                    // Без подзадач прогресс равен 100% если задача выполнена
                    Completness = CompleteFlag ? 100 : 0;
                }
                else
                {
                    // С подзадачами считаем прогресс по выполненным подзадачам
                    var completedSubTasks = SubTasks.Count(t => t.CompleteFlag);
                    Completness = SubTasks.Count > 0 ?
                        (int)Math.Round((double)completedSubTasks / SubTasks.Count * 100) : 0;

                    // Синхронизируем CompleteFlag с прогрессом
                    if (Completness == 100 && !CompleteFlag)
                    {
                        _completeFlag = true;
                        OnPropertyChanged(nameof(CompleteFlag));
                    }
                    else if (Completness < 100 && CompleteFlag)
                    {
                        _completeFlag = false;
                        OnPropertyChanged(nameof(CompleteFlag));
                    }
                }
            }
            finally
            {
                _isUpdating = false;
            }
        }

        public override string ToString()
        {
            string subTasksInfo = HasSubTasks ? $" [Подзадачи: {SubTasks.Count}]" : "";
            return $"{Name} ({Completness}%) - {Description}{subTasksInfo}";
        }

        public event PropertyChangedEventHandler PropertyChanged;

        protected virtual void OnPropertyChanged([CallerMemberName] string propertyName = null)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }
    }
}